<?xml version="1.0" encoding="utf-8"?>
  <rss version="2.0"
        xmlns:content="http://purl.org/rss/1.0/modules/content/"
        xmlns:atom="http://www.w3.org/2005/Atom"
  >
  <channel>
    <title>William Fang</title>
    <link href="http://williamlfang.github.com/cn/feed/" rel="self" />
    <link href="http://webfrogs.github.com" />
    <lastBuildDate>2014-02-23T12:53:36+08:00</lastBuildDate>
    <webMaster>ccf.developer@gmail.com</webMaster>
    
    <item>
      <title>pickle模块简介与一个简单的clojure实现</title>
      <link href="http://williamlfang.github.com/cn/2013/06/26/brief-analysis-on-pickle-and-an-implementation-in-clojure/"/>
      <pubDate>2013-06-26T00:00:00+08:00</pubDate>
      <author>William Fang</author>
      <guid>http://williamlfang.github.com/cn/2013/06/26/brief-analysis-on-pickle-and-an-implementation-in-clojure</guid>
      <content:encoded><![CDATA[<p>有段时间突然对二进制的数据产生了强烈的兴趣（具体原因可能是因为解析坦克世界的<code>dossier.dat</code>可以获得平时看不到的数据），寒假在家也闲不住，就跑去研究了一下pickle这个模块（坦克世界的那些数据实际上也就是pickle之后的东西）。然后用clojure做了一个<a href="https://github.com/mad4alcohol/naive-unpickler-clj">简易的unpickle库</a>，未来可能在有时间的时候会添加pickle的功能。</p>

<h2 id="section">准备工作</h2>

<p>如何去了解一个不了解的东西？Google。Google不到怎么破？源码。</p>

<p>翻了一下python的<code>Lib</code>文件夹，发现了两个有关的东西：<code>pickle.py</code>，<code>pickletools.py</code>。打开<code>pickletools.py</code>看一下，<code>"Executable documentation" for the pickle module</code>，看来是找对地方了。</p>

<h2 id="pickle">pickle的简介</h2>

<p>文档说的总会比我说的清楚，这里就摘抄几段文档了。</p>

<p>一个”pickle”是一个给pickle虚拟机（PM）使用的程序。它是一系列的操作码（opcode），被PM解释后，用来创建任意复杂的Python对象。总体来说PM非常简单：操作码每个被执行一次，从第一个到最后一个，直到碰到了<code>STOP</code>操作码。</p>

<p>PM有两个数据域：栈（stack）和备忘（memo）。</p>

<p>许多操作码把Python对象压到栈里，比如<code>INT</code>把一个Python整数对象压到栈里，这个整数对象的值从一个在pickle字节流中紧跟在<code>INT</code>操作码后面的十进制字符串字面量中取得。另外有一些操作码把Python对象弹出栈中。unpickling的结果就是当执行到<code>STOP</code>操作码时，留在栈顶的那个东西了。</p>

<p>备忘仅仅只是一个存放对象的数组，或者也能被实现成一个从小整数映射到对象的字典。备忘是PM的“长期记忆”，那些为备忘提供索引的小整数类似于变量名。有些操作码把对象从栈顶弹出后放入备忘的一个指定索引里，另外一些把给定索引处的备忘对象再压回栈里。</p>

<p>以上基本上就是pickle的工作原理了。</p>

<p>具体的pickle操作码的定义被称为pickle协议，由于历史原因pickle协议存在多个版本，但是令人感到安心的是，pickle操作码的意义永远不变，即高版本兼容低版本，令人感到不安的是，对于实现者工作量就会大些了。</p>

<p>最原始的pickle现在被称为“协议0”，并且在Python 2.3前被称为“文字模式（text mode）”。整个pickle字节流由可打印的7位ASCII字符加上换行符组成。这也是它被称为文字模式的原因。协议0小且优雅，但是有时极其低效。</p>

<p>第二个主要的协议版本现在被称为“协议1”，并且在Python 2.3前被称为“二进制模式（binary mode）”。增加了许多参数可以包含任意长度字节的操作码。通常二进制模式的pickle比文字模式的占用的空间要小，有时也会更快。协议1也添加了几个立即操作多个栈上元素的操作码（如<code>APPENDS</code>和<code>SETITEMS</code>）和“快捷”操作码（如<code>EMPTY_DICT</code>和<code>EMPTY_TUPLE</code>）。</p>

<p>第三个主要的协议版本在Python 2.3中被引入，被称作“协议2”。具体内容这里就略去了。因为这篇文章只会用clojure实现协议1（当然也包括了协议0），协议2等我熟悉了clojure的面向对象编程再说吧。</p>

<h2 id="section-1">在开始实现之前</h2>

<p>先阅读一下<code>pickletools.py</code>的其他部分，翻了一下，在883行发现了一个叫<code>opcodes</code>的list，可以说是pickle协议的可执行版本，讲解了操作码的名称，码值，参数，执行前后栈的变化情况，提供该操作码的协议版本和该操作码的文档。</p>

<p>比如</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">I</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;LONG&#39;</span><span class="p">,</span>
<span class="lineno">2</span>   <span class="n">code</span><span class="o">=</span><span class="s">&#39;L&#39;</span><span class="p">,</span>
<span class="lineno">3</span>   <span class="n">arg</span><span class="o">=</span><span class="n">decimalnl_long</span><span class="p">,</span>
<span class="lineno">4</span>   <span class="n">stack_before</span><span class="o">=</span><span class="p">[],</span>
<span class="lineno">5</span>   <span class="n">stack_after</span><span class="o">=</span><span class="p">[</span><span class="n">pylong</span><span class="p">],</span>
<span class="lineno">6</span>   <span class="n">proto</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="lineno">7</span>   <span class="n">doc</span><span class="o">=</span><span class="s">&quot;&quot;&quot;...&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>告诉我们<code>LONG</code>这个操作码，实际的码值（在字节流中的值）是’L’，即76，参数是<code>decimalnl_long</code>，在执行这个操作码后，栈上会多一个pylong对象，协议0提供这个操作码。</p>

<p>再看<code>decimalnl_long</code>是什么玩意，</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">decimalnl_long</span> <span class="o">=</span> <span class="n">ArgumentDescriptor</span><span class="p">(</span>
<span class="lineno">2</span>                      <span class="n">name</span><span class="o">=</span><span class="s">&#39;decimalnl_long&#39;</span><span class="p">,</span>
<span class="lineno">3</span>                      <span class="n">n</span><span class="o">=</span><span class="n">UP_TO_NEWLINE</span><span class="p">,</span>
<span class="lineno">4</span>                      <span class="n">reader</span><span class="o">=</span><span class="n">read_decimalnl_long</span><span class="p">,</span>
<span class="lineno">5</span>                      <span class="n">doc</span><span class="o">=</span><span class="s">&quot;&quot;&quot;A newline-terminated decimal integer literal.</span>
<span class="lineno">6</span> <span class="s">                            ...&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>看doc说，<code>decimalnl_long</code>是一个以换行符结尾的十进制整数字面量。而且看它的<code>reader</code>项目可以看到这个参数的读取的具体实现，也就是<code>read_decimalnl_long</code>，如下</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">read_decimalnl_long</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="n">s</span> <span class="o">=</span> <span class="n">read_stringnl</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stripquotes</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno">3</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">):</span>
<span class="lineno">4</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;trailing &#39;L&#39; required in </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
<span class="lineno">5</span>     <span class="k">return</span> <span class="nb">long</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre>
</div>

<p>这个函数实际上是很简单的，用<code>read_stringnl</code>读取一个以换行结尾的字符串，并且判断它尾巴上有没有一个<code>L</code>，如果有<code>L</code>就用built-in函数<code>long</code>把这个字符串转换成一个<code>long</code>对象。</p>

<p>如果总结一下，对字节流的操作可以综合成以下几个操作：</p>

<ul>
  <li>读下一个字节</li>
  <li>读下一行</li>
  <li>读下四个字节</li>
  <li>读下n个字节</li>
</ul>

<p>这也是会在clojure里实现的几个基本操作。</p>

<h2 id="section-2">开始实现</h2>

<p>如果仿照<code>pickletools.py</code>里的写法，在clojure里我们可以自己定义一个<code>defxxx</code>，比如<code>defopcode</code>，当然这个<code>defopcode</code>得用宏来实现。</p>

<p><code>defopcode</code>的基本操作就是修改维护的一个<code>map</code>，码值做键，具体的操作函数做值，这个操作函数接受三个参数，即字节流对象、栈对象和备忘对象，其中栈对象用<code>vector</code>实现，备忘对象用<code>map</code>实现，在函数内部对按照协议操作后，返回新的栈和备忘，作为下次执行所使用的栈和备忘。</p>

<p>在unpickle的时候，每次读入一个字节，然后通过这个<code>map</code>获得对应的操作函数，把需要的参数传递进去，并且接收好返回值，在loop的时候注意<code>STOP</code>操作码的判断，如果操作码是<code>STOP</code>，则立即停止recur，并返回栈顶元素。</p>

<p>在这个实现中有一个遗憾就是不能很好的实现<code>defopcode</code>这个宏，以至于每个操作码的定义后面都需要显式地写出返回值（即stack和memo）。</p>

<p>这里举一个例子</p>

<div class="highlight"><pre><code class="clojure"><span class="lineno">1</span> <span class="p">(</span><span class="nf">defopcode</span> <span class="nv">BINUNICODE</span> <span class="sc">\X</span>
<span class="lineno">2</span>   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">len</span> <span class="p">(</span><span class="nf">from-byte-vector-lendian</span> <span class="p">(</span><span class="nf">next-4-byte</span><span class="p">))</span>
<span class="lineno">3</span>         <span class="nv">data</span> <span class="p">(</span><span class="nf">next-n-byte</span> <span class="nv">len</span><span class="p">)]</span>
<span class="lineno">4</span>     <span class="p">[(</span><span class="nb">conj </span><span class="nv">stack</span>
<span class="lineno">5</span>            <span class="p">(</span><span class="nf">String.</span> <span class="p">(</span><span class="nf">to-java-byte-array</span> <span class="nv">data</span><span class="p">)</span>
<span class="lineno">6</span>                     <span class="s">&quot;utf-8&quot;</span><span class="p">))</span>
<span class="lineno">7</span>      <span class="nv">memo</span><span class="p">]))</span>
</code></pre>
</div>

<p>首先将字节流当前位置的后面4个字节读出来并且按小端（little endian）转换成一个<code>int</code>，使用的是自己写的函数<code>from-byte-vector-lendian</code>（python可以直接使用<code>struct.unpack</code>），绑定给<code>len</code>，随后又读取<code>len</code>个字节绑定给<code>data</code>，最后将<code>data</code>按<code>utf-8</code>解码为unicode的<code>String</code>后，压栈并返回。</p>

<p>这里不得不提的是java的<code>byte</code>类型很奇怪，竟然是带符号的，所以如果某个字节大于128（<code>0b10000000</code>）需要转换成<code>byte</code>，需要减掉256，把它变成负数，比如129（<code>0b10000001</code>）直接赋给<code>byte</code>是不行的，但是如果把它减掉256，变成-127，在补码下它的二进制表示仍然是<code>0b10000001</code>，这样就既没有破坏数据又可以被java接受了。</p>

<h2 id="section-3">后记</h2>

<p>感觉上用clojure实现协议1（包括部分协议2）的PM，要说的就是这么多（篇幅上来说比想象中的要短不少啊）。这回使用的编辑器依然是&lt;font color=red&gt;THE MIGHTY EMACS&lt;/font&gt;，插件是很好用的nrepl，也算是体验了一下Lisp的开发方式，非常快捷方便，但是由于我个人的原因，开发起来还不是很熟练，最近买了O’reilly的《Clojure编程》打算系统地学习一下clojure。另外一个感觉是clojure的文档有些地方对于我来说不是很好用，比如clojure 1.4里面很多包名都从contrib里面移出去了，我找这方面的文档找了半天还是没找到（以前找到过一次貌似，但是寒假里没找到），还有就是clojure的错误信息有些时候很难读懂，这个可能跟经验有关，以后再慢慢积累吧。</p>

]]></content:encoded>
    </item>
    
    <item>
      <title>Log Handler With Qtextbrowser</title>
      <link href="http://williamlfang.github.com/cn/2013/05/13/log-handler-with-qtextbrowser/"/>
      <pubDate>2013-05-13T00:00:00+08:00</pubDate>
      <author>William Fang</author>
      <guid>http://williamlfang.github.com/cn/2013/05/13/log-handler-with-qtextbrowser</guid>
      <content:encoded><![CDATA[<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta http-equiv="x-ua-compatible" content="IE=9" >

<title>前述</title>

<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 12px;
   margin: 8px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 { 
   font-size:2.2em; 
}

h2 { 
   font-size:1.8em; 
}

h3 { 
   font-size:1.4em; 
}

h4 { 
   font-size:1.0em; 
}

h5 { 
   font-size:0.9em; 
}

h6 { 
   font-size:0.8em; 
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre {	
   margin-top: 0;
   max-width: 95%;
   border: 1px solid #ccc;
   white-space: pre-wrap;
}

pre code {
   display: block; padding: 0.5em;
}

code.r, code.cpp {
   background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * { 
      background: transparent !important; 
      color: black !important; 
      filter:none !important; 
      -ms-filter: none !important; 
   }

   body { 
      font-size:12pt; 
      max-width:100%; 
   }
       
   a, a:visited { 
      text-decoration: underline; 
   }

   hr { 
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote { 
      padding-right: 1em; 
      page-break-inside: avoid; 
   }

   tr, img { 
      page-break-inside: avoid; 
   }

   img { 
      max-width: 100% !important; 
   }

   @page :left { 
      margin: 15mm 20mm 15mm 10mm; 
   }
     
   @page :right { 
      margin: 15mm 10mm 15mm 20mm; 
   }

   p, h2, h3 { 
      orphans: 3; widows: 3; 
   }

   h2, h3 { 
      page-break-after: avoid; 
   }
}

</style>





</head>

<body>
<h2>前述</h2>

<p>在<a href="../../12/pyqt-model-view-framework/">之前的一篇文章</a>里说过，log这种流动的文字信息可以用<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a>来展示。这篇文章会演示如何实现一个log窗口，而且还能根据特定log等级变化颜色。</p>

<p>最终效果
<img src="/assets/images/log-handler-with-qtextbrowser/overview.png" alt="overview.png"/></p>

<p>实现可以分成3步</p>

<ul>
<li>在Qt中实现带颜色的文字显示</li>
<li>在python中实现log颜色的格式化</li>
<li>连接python中的<a href="http://docs.python.org/2/library/logging.html#logging.Logger">logging.Logger</a>和Qt中的<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a></li>
</ul>

<h2>在Qt中实现带颜色的文字显示</h2>

<p>很简单，有了<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a>之后，使用<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html#append"><code>append()</code></a>槽就可以往里面添加了。而且QTextBrowser还支持html，也就是你可以在程序里写（至少是简单的）html代码，Qt可以正确的渲染出来。
比如
<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="lineno">2</span> <span class="n">text_browser</span> <span class="o">=</span> <span class="n">QTextBrowser</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="lineno">3</span> 
<span class="lineno">4</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">text_browser</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;&lt;b&gt;this&lt;/b&gt; is &lt;font color=blue&gt;&lt;i&gt;append&lt;/i&gt;&lt;/font&gt;ed&amp;#39;</span>
<span class="lineno">5</span>                   <span class="o">&amp;</span><span class="c">#39; into &lt;code&gt;text_browser&lt;/code&gt;&amp;#39;)&lt;/p&gt;</span>
<span class="lineno">6</span> 
<span class="lineno">7</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">text</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">browser</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="lineno">8</span> <span class="n">app</span><span class="o">.</span><span class="k">exec</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="p">()</span>
</code></pre>
</div>

如图 <img src="/assets/images/log-handler-with-qtextbrowser/render-html.png" alt="render-html.png"/></p>

<h2>在python中实现log颜色的格式化</h2>

<p>为了能在logger的工作流程里插一手，我们只有实现自己的<a href="http://docs.python.org/2/library/logging.html#logging.Formatter">Formatter</a>这一条路走。</p>

<p>我们的主要思路就是，在<a href="http://docs.python.org/2/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a>中，把给传入的参数的每个需要格式化的值外面套上<code>&lt;font color=%1&gt;</code>和<code>&lt;/font&gt;</code>，所以我们需要一个表，来确定什么参数要用什么颜色，像这样
<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="o">&amp;</span><span class="c">#39;asctime&amp;#39;: &amp;#39;blue&amp;#39;,</span>
<span class="lineno">3</span>     <span class="o">&amp;</span><span class="c">#39;message&amp;#39;: &amp;#39;green&amp;#39;</span>
<span class="lineno">4</span> <span class="p">}</span>
</code></pre>
</div>

但是这样不够灵活，如果这样写，我们怎么来按照log等级来选择不停的颜色呢，所以可以这样
<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="o">&amp;</span><span class="c">#39;asctime&amp;#39;: lambda _: &amp;#39;blue&amp;#39;,</span>
<span class="lineno">3</span>     <span class="o">&amp;</span><span class="c">#39;levelname&amp;#39;: lambda record: {&amp;#39;DEBUG&amp;#39;: &amp;#39;gray&amp;#39;,</span>
<span class="lineno">4</span>                                  <span class="o">&amp;</span><span class="c">#39;INFO&amp;#39; : &amp;#39;green&amp;#39;,</span>
<span class="lineno">5</span>                                  <span class="o">&amp;</span><span class="c">#39;WARNING&amp;#39;: &amp;#39;orange&amp;#39;}[record.levelname]</span>
<span class="lineno">6</span> <span class="p">}</span>
</code></pre>
</div>

也就是颜色表的值是一个函数，按照输入来确定颜色，如果这么写，理论上（实际上也是可以实现的）我们甚至可以按照时间的不同来显示不同的颜色
<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="o">&amp;</span><span class="c">#39;asctime&amp;#39;: lambda t: &amp;#39;blue&amp;#39; if int(t) % 2 else &amp;#39;red&amp;#39;</span>
<span class="lineno">3</span> <span class="p">}</span>
</code></pre>
</div>

效果如图 <img src="/assets/images/log-handler-with-qtextbrowser/asctime-change-color.png" alt="asctime-change-color.png"/></p>

<p>接下来我们来着手重载<a href="http://docs.python.org/2/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a></p>

<p><a href="http://docs.python.org/2/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a>带了一个参数<code>record</code>，保证了是<a href="http://docs.python.org/2/library/logging.html#logging.LogRecord">LogRecord</a>类的实例，我们要格式化的内容就在这个里面。但是我们只是一个formatter，不应该修改这个record，所以我们应该做一个这个record的拷贝，在这个拷贝的基础上，我们再来格式化log信息。
<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="n">makeLogRecord</span><span class="p">(</span><span class="n">record</span><span class="o">.&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="nb">dict</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">_</span><span class="p">)</span>
</code></pre>
</div>

其中<code>makeLogRecord</code>函数是我在logging库的源码里找到的，manual里好像没记录这个东西。</p>

<p>接下来根据<code>colors</code>表来格式化各个项目，需要注意的是，我们要对<code>asctime</code>这个项目做特殊处理，因为</p>

<ul>
<li>首先，<a href="http://docs.python.org/2/library/logging.html#logging.LogRecord">LogRecord</a>对象里面没有<code>asctime</code>这个属性，但是为了跟格式化字符串<code>fmt</code>保持一致的关键字，我还是决定继续用<code>asctime</code></li>
<li>其次，超类里的<code>format</code>方法会自己调用<a href="http://docs.python.org/2/library/logging.html#logging.Formatter.formatTime">formatTime()</a>，然后我们对<code>asctime</code>做的颜色格式化就被覆盖了</li>
</ul>

<p>所以基本上来说，因为<code>asctime</code>的原因，我们不能简单地按项目格式化他们的颜色之后简单的调用<code>super(ColoredFormatter, self).format(_r)</code>了。代码如下
<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span>     <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">:</span>
<span class="lineno"> 2</span>         <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="o">&amp;</span><span class="c">#39;asctime&amp;#39;:</span>
<span class="lineno"> 3</span>             <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatTime</span><span class="p">(</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datefmt</span><span class="p">)</span>
<span class="lineno"> 4</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 5</span>             <span class="n">info</span> <span class="o">=</span> <span class="n">_r</span><span class="o">.&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">getattribute</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="lineno"> 6</span>         <span class="n">_r</span><span class="o">.&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="nb">setattr</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">_</span><span class="p">(</span><span class="n">item</span><span class="p">,</span>
<span class="lineno"> 7</span>                        <span class="o">&amp;</span><span class="c">#39;&lt;font color=%s&gt;%s&lt;/font&gt;&amp;#39; % (</span>
<span class="lineno"> 8</span>                            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;_r&quot;</span><span class="o">&gt;</span><span class="n">item</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span><span class="p">,</span>
<span class="lineno"> 9</span>                            <span class="n">info</span>
<span class="lineno">10</span>                        <span class="p">))</span>
<span class="lineno">11</span>     <span class="n">_r</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">_r</span><span class="o">.</span><span class="n">getMessage</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usesTime</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="o">&amp;</span><span class="c">#39;asctime&amp;#39; in self.colors:</span>
<span class="lineno">14</span>     <span class="n">_r</span><span class="o">.</span><span class="n">asctime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatTime</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datefmt</span><span class="p">)</span>
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span> <span class="o">%</span> <span class="n">_r</span><span class="o">.</span><span class="n">__dict__</span>
<span class="lineno">17</span> <span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</code></pre>
</div>
</p>

<p><code>for</code>后面那一段基本上按照<a href="http://docs.python.org/2/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a>的源码写的，但是为了简单没有照抄后面关于异常的格式化。</p>

<h2>连接python中的<a href="http://docs.python.org/2/library/logging.html#logging.Logger">logging.Logger</a>和Qt中的<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a></h2>

<p>上面介绍了在log信息格式化中插一手的方法，现在介绍在log信息传播中插一手的方法。</p>

<p>使用<a href="http://docs.python.org/2/library/logging.html#handler-objects">logging.Handler</a>来实现log信息转播到Qt中的控件中，具体方法是实现<a href="http://docs.python.org/2/library/logging.html#handler-objects">Handler</a>的子类。
实现这个子类很简单，只需要实现一个方法<a href="http://docs.python.org/2/library/logging.html#logging.Handler.emit"><code>Handler.emit()</code></a>，在这个方法中写操作[<code>QTextBrowser</code>]的相关代码。为了实现线程安全，我们需要利用Qt的信号/槽机制（这个机制天生就是线程安全的），但是[<code>QTextBrowser</code>]并没有提供添加信息的信号供我们发射，只提供了一个槽。所以我们得自己做一个信号
<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">append_to_widget</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="n">widget</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre>
</div>
</p>

<p>然后Handler的子类代码如下
<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">LoggerHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="k">def</span> <span class="err">&lt;</span><span class="nf">strong</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">widget</span><span class="p">):</span>
<span class="lineno"> 3</span>         <span class="bp">self</span><span class="o">.</span><span class="n">logger_widget</span> <span class="o">=</span> <span class="n">logger_widget</span>
<span class="lineno"> 4</span>         <span class="nb">super</span><span class="p">(</span><span class="n">LoggerHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">init</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">_</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="lineno"> 7</span>     <span class="bp">self</span><span class="o">.</span><span class="n">logger_widget</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">SIGNAL</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;new_log(QString)&amp;#39;),</span>
<span class="lineno"> 8</span>                             <span class="n">QString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;utf-8&amp;#39;)))</span>
<span class="lineno"> 9</span> <span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</code></pre>
</div>
</p>

<p>然后配置代码如下
<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">name</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">LoggerHandler</span><span class="p">(</span><span class="n">text_browser</span><span class="p">)</span>
<span class="lineno"> 4</span> <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">ColoredFormatter</span><span class="p">(</span>
<span class="lineno"> 5</span>     <span class="n">fmt</span><span class="o">=&amp;</span><span class="c">#39;%(asctime)s %(levelname)s %(message)s&amp;#39;,</span>
<span class="lineno"> 6</span>     <span class="n">datefmt</span><span class="o">=&amp;</span><span class="c">#39;%m/%dT%H:%M:%S&amp;#39;,</span>
<span class="lineno"> 7</span>     <span class="n">colors</span><span class="o">=</span><span class="p">{</span><span class="o">&amp;</span><span class="c">#39;asctime&amp;#39;: lambda _: &amp;#39;blue&amp;#39;,</span>
<span class="lineno"> 8</span>             <span class="o">&amp;</span><span class="c">#39;levelname&amp;#39;: lambda record:</span>
<span class="lineno"> 9</span>                 <span class="n">ColoredFormatter</span><span class="o">.</span><span class="n">gen_colorscheme</span><span class="p">()[</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">]}</span>
<span class="lineno">10</span> <span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">text_browser</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">text_browser</span><span class="p">,</span>
<span class="lineno">15</span>                      <span class="n">SIGNAL</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;new_log(QString)&amp;#39;),</span>
<span class="lineno">16</span>                      <span class="k">lambda</span> <span class="n">log</span><span class="p">:</span> <span class="n">append_to_widget</span><span class="p">(</span><span class="n">text_browser</span><span class="p">,</span> <span class="n">log</span><span class="p">))</span>
</code></pre>
</div>
</p>

<p>其中<code>ColoredFormatter.gen_colorscheme()</code>是我另外写的一个convenience函数，就是返回了一个默认的字典罢了，不多说。</p>

<p>测试代码
<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;debug&amp;#39;)</span>
<span class="lineno">2</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;info&amp;#39;)</span>
<span class="lineno">3</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;warning&amp;#39;)</span>
<span class="lineno">4</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;error&amp;#39;)</span>
<span class="lineno">5</span> <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="o">&amp;</span><span class="c">#39;critical&amp;#39;)</span>
</code></pre>
</div>
</p>

<p>最终效果如图 <img src="/assets/images/log-handler-with-qtextbrowser/final.png" alt="final.png"/></p>

<h2>扩展阅读</h2>

<ul>
<li><a href="http://docs.python.org/2/howto/logging.html#logging-basic-tutorial">基础的logging教程</a></li>
<li><a href="http://docs.python.org/2/library/logging.handlers.html#module-logging.handlers">Python内置的handler，壮哉我大Python Stdlib</a></li>
<li><a href="http://docs.python.org/2/howto/logging-cookbook.html#logging-cookbook">Logging Cookbook</a></li>
</ul>

</body>

</html>

]]></content:encoded>
    </item>
    
    <item>
      <title>在PyQt中实现一个可以变色的log窗口</title>
      <link href="http://williamlfang.github.com/cn/2013/05/13/log-handler-with-qtextbrowser/"/>
      <pubDate>2013-05-13T00:00:00+08:00</pubDate>
      <author>William Fang</author>
      <guid>http://williamlfang.github.com/cn/2013/05/13/log-handler-with-qtextbrowser</guid>
      <content:encoded><![CDATA[<h2 id="section">前述</h2>

<p>在<a href="../../12/pyqt-model-view-framework/">之前的一篇文章</a>里说过，log这种流动的文字信息可以用<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a>来展示。这篇文章会演示如何实现一个log窗口，而且还能根据特定log等级变化颜色。</p>

<p>最终效果
<img src="/assets/images/log-handler-with-qtextbrowser/overview.png" alt="overview.png" /></p>

<p>实现可以分成3步</p>

<ul>
  <li>在Qt中实现带颜色的文字显示</li>
  <li>在python中实现log颜色的格式化</li>
  <li>连接python中的<a href="http://docs.python.org/2/library/logging.html#logging.Logger">logging.Logger</a>和Qt中的<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a></li>
</ul>

<h2 id="qt">在Qt中实现带颜色的文字显示</h2>

<p>很简单，有了<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a>之后，使用<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html#append"><code>append()</code></a>槽就可以往里面添加了。而且QTextBrowser还支持html，也就是你可以在程序里写（至少是简单的）html代码，Qt可以正确的渲染出来。
比如</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="lineno">2</span> <span class="n">text_browser</span> <span class="o">=</span> <span class="n">QTextBrowser</span><span class="p">()</span>
<span class="lineno">3</span> 
<span class="lineno">4</span> <span class="n">text_browser</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;b&gt;this&lt;/b&gt; is &lt;font color=blue&gt;&lt;i&gt;append&lt;/i&gt;&lt;/font&gt;ed&#39;</span>
<span class="lineno">5</span>                   <span class="s">&#39; into &lt;code&gt;text_browser&lt;/code&gt;&#39;</span><span class="p">)</span>
<span class="lineno">6</span> 
<span class="lineno">7</span> <span class="n">text_browser</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="lineno">8</span> <span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
</code></pre>
</div>

<p>如图 <img src="/assets/images/log-handler-with-qtextbrowser/render-html.png" alt="render-html.png" /></p>

<h2 id="pythonlog">在python中实现log颜色的格式化</h2>

<p>为了能在logger的工作流程里插一手，我们只有实现自己的<a href="http://docs.python.org/2/library/logging.html#logging.Formatter">Formatter</a>这一条路走。</p>

<p>我们的主要思路就是，在<a href="http://docs.python.org/2/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a>中，把给传入的参数的每个需要格式化的值外面套上<code>&lt;font color=%1&gt;</code>和<code>&lt;/font&gt;</code>，所以我们需要一个表，来确定什么参数要用什么颜色，像这样</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="s">&#39;asctime&#39;</span><span class="p">:</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span>
<span class="lineno">3</span>     <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;green&#39;</span>
<span class="lineno">4</span> <span class="p">}</span>
</code></pre>
</div>

<p>但是这样不够灵活，如果这样写，我们怎么来按照log等级来选择不停的颜色呢，所以可以这样</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="s">&#39;asctime&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span>
<span class="lineno">3</span>     <span class="s">&#39;levelname&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;DEBUG&#39;</span><span class="p">:</span> <span class="s">&#39;gray&#39;</span><span class="p">,</span>
<span class="lineno">4</span>                                  <span class="s">&#39;INFO&#39;</span> <span class="p">:</span> <span class="s">&#39;green&#39;</span><span class="p">,</span>
<span class="lineno">5</span>                                  <span class="s">&#39;WARNING&#39;</span><span class="p">:</span> <span class="s">&#39;orange&#39;</span><span class="p">}[</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">]</span>
<span class="lineno">6</span> <span class="p">}</span>
</code></pre>
</div>

<p>也就是颜色表的值是一个函数，按照输入来确定颜色，如果这么写，理论上（实际上也是可以实现的）我们甚至可以按照时间的不同来显示不同的颜色</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="s">&#39;asctime&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="s">&#39;blue&#39;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">else</span> <span class="s">&#39;red&#39;</span>
<span class="lineno">3</span> <span class="p">}</span>
</code></pre>
</div>

<p>效果如图 <img src="/assets/images/log-handler-with-qtextbrowser/asctime-change-color.png" alt="asctime-change-color.png" /></p>

<p>接下来我们来着手重载<a href="http://docs.python.org/2/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a></p>

<p><a href="http://docs.python.org/2/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a>带了一个参数<code>record</code>，保证了是<a href="http://docs.python.org/2/library/logging.html#logging.LogRecord">LogRecord</a>类的实例，我们要格式化的内容就在这个里面。但是我们只是一个formatter，不应该修改这个record，所以我们应该做一个这个record的拷贝，在这个拷贝的基础上，我们再来格式化log信息。</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="n">_r</span> <span class="o">=</span> <span class="n">makeLogRecord</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
</code></pre>
</div>

<p>其中<code>makeLogRecord</code>函数是我在logging库的源码里找到的，manual里好像没记录这个东西。</p>

<p>接下来根据<code>colors</code>表来格式化各个项目，需要注意的是，我们要对<code>asctime</code>这个项目做特殊处理，因为
* 首先，<a href="http://docs.python.org/2/library/logging.html#logging.LogRecord">LogRecord</a>对象里面没有<code>asctime</code>这个属性，但是为了跟格式化字符串<code>fmt</code>保持一致的关键字，我还是决定继续用<code>asctime</code>
* 其次，超类里的<code>format</code>方法会自己调用<a href="http://docs.python.org/2/library/logging.html#logging.Formatter.formatTime">formatTime()</a>，然后我们对<code>asctime</code>做的颜色格式化就被覆盖了</p>

<p>所以基本上来说，因为<code>asctime</code>的原因，我们不能简单地按项目格式化他们的颜色之后简单的调用<code>super(ColoredFormatter, self).format(_r)</code>了。代码如下</p>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span>     <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">:</span>
<span class="lineno"> 2</span>         <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&#39;asctime&#39;</span><span class="p">:</span>
<span class="lineno"> 3</span>             <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatTime</span><span class="p">(</span><span class="n">_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datefmt</span><span class="p">)</span>
<span class="lineno"> 4</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 5</span>             <span class="n">info</span> <span class="o">=</span> <span class="n">_r</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="lineno"> 6</span>         <span class="n">_r</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">item</span><span class="p">,</span>
<span class="lineno"> 7</span>                        <span class="s">&#39;&lt;font color=</span><span class="si">%s</span><span class="s">&gt;</span><span class="si">%s</span><span class="s">&lt;/font&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
<span class="lineno"> 8</span>                            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">item</span><span class="p">](</span><span class="n">_r</span><span class="p">),</span>
<span class="lineno"> 9</span>                            <span class="n">info</span>
<span class="lineno">10</span>                        <span class="p">))</span>
<span class="lineno">11</span>     <span class="n">_r</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">_r</span><span class="o">.</span><span class="n">getMessage</span><span class="p">()</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usesTime</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;asctime&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">:</span>
<span class="lineno">14</span>         <span class="n">_r</span><span class="o">.</span><span class="n">asctime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatTime</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datefmt</span><span class="p">)</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt</span> <span class="o">%</span> <span class="n">_r</span><span class="o">.</span><span class="n">__dict__</span>
</code></pre>
</div>

<p><code>for</code>后面那一段基本上按照<a href="http://docs.python.org/2/library/logging.html#logging.Formatter.format"><code>Formatter.format()</code></a>的源码写的，但是为了简单没有照抄后面关于异常的格式化。</p>

<h2 id="pythonloggingloggerqtqtextbrowser">连接python中的<a href="http://docs.python.org/2/library/logging.html#logging.Logger">logging.Logger</a>和Qt中的<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a></h2>

<p>上面介绍了在log信息格式化中插一手的方法，现在介绍在log信息传播中插一手的方法。</p>

<p>使用<a href="http://docs.python.org/2/library/logging.html#handler-objects">logging.Handler</a>来实现log信息转播到Qt中的控件中，具体方法是实现<a href="http://docs.python.org/2/library/logging.html#handler-objects">Handler</a>的子类。
实现这个子类很简单，只需要实现一个方法<a href="http://docs.python.org/2/library/logging.html#logging.Handler.emit"><code>Handler.emit()</code></a>，在这个方法中写操作[<code>QTextBrowser</code>]的相关代码。为了实现线程安全，我们需要利用Qt的信号/槽机制（这个机制天生就是线程安全的），但是[<code>QTextBrowser</code>]并没有提供添加信息的信号供我们发射，只提供了一个槽。所以我们得自己做一个信号</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">append_to_widget</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="n">widget</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre>
</div>

<p>然后Handler的子类代码如下</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">class</span> <span class="nc">LoggerHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger_widget</span><span class="p">):</span>
<span class="lineno">3</span>         <span class="bp">self</span><span class="o">.</span><span class="n">logger_widget</span> <span class="o">=</span> <span class="n">logger_widget</span>
<span class="lineno">4</span>         <span class="nb">super</span><span class="p">(</span><span class="n">LoggerHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="lineno">5</span> 
<span class="lineno">6</span> 
<span class="lineno">7</span>     <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="lineno">8</span>         <span class="bp">self</span><span class="o">.</span><span class="n">logger_widget</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s">&#39;new_log(QString)&#39;</span><span class="p">),</span>
<span class="lineno">9</span>                                 <span class="n">QString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)))</span>
</code></pre>
</div>

<p>然后配置代码如下</p>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">LoggerHandler</span><span class="p">(</span><span class="n">text_browser</span><span class="p">)</span>
<span class="lineno"> 4</span> <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">ColoredFormatter</span><span class="p">(</span>
<span class="lineno"> 5</span>     <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(levelname)s</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span>
<span class="lineno"> 6</span>     <span class="n">datefmt</span><span class="o">=</span><span class="s">&#39;%m/</span><span class="si">%d</span><span class="s">T%H:%M:%S&#39;</span><span class="p">,</span>
<span class="lineno"> 7</span>     <span class="n">colors</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;asctime&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span>
<span class="lineno"> 8</span>             <span class="s">&#39;levelname&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">record</span><span class="p">:</span>
<span class="lineno"> 9</span>                 <span class="n">ColoredFormatter</span><span class="o">.</span><span class="n">gen_colorscheme</span><span class="p">()[</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">]}</span>
<span class="lineno">10</span> <span class="p">))</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="n">text_browser</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">text_browser</span><span class="p">,</span>
<span class="lineno">15</span>                      <span class="n">SIGNAL</span><span class="p">(</span><span class="s">&#39;new_log(QString)&#39;</span><span class="p">),</span>
<span class="lineno">16</span>                      <span class="k">lambda</span> <span class="n">log</span><span class="p">:</span> <span class="n">append_to_widget</span><span class="p">(</span><span class="n">text_browser</span><span class="p">,</span> <span class="n">log</span><span class="p">))</span>
</code></pre>
</div>

<p>其中<code>ColoredFormatter.gen_colorscheme()</code>是我另外写的一个convenience函数，就是返回了一个默认的字典罢了，不多说。</p>

<p>测试代码</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">)</span>
<span class="lineno">2</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;info&#39;</span><span class="p">)</span>
<span class="lineno">3</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;warning&#39;</span><span class="p">)</span>
<span class="lineno">4</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error&#39;</span><span class="p">)</span>
<span class="lineno">5</span> <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;critical&#39;</span><span class="p">)</span>
</code></pre>
</div>

<p>最终效果如图 <img src="/assets/images/log-handler-with-qtextbrowser/final.png" alt="final.png" /></p>

<h2 id="section-1">扩展阅读</h2>

<ul>
  <li><a href="http://docs.python.org/2/howto/logging.html#logging-basic-tutorial">基础的logging教程</a></li>
  <li><a href="http://docs.python.org/2/library/logging.handlers.html#module-logging.handlers">Python内置的handler，壮哉我大Python Stdlib</a></li>
  <li><a href="http://docs.python.org/2/howto/logging-cookbook.html#logging-cookbook">Logging Cookbook</a></li>
</ul>

]]></content:encoded>
    </item>
    
    <item>
      <title>PyQt的Model/View框架的个人总结</title>
      <link href="http://williamlfang.github.com/cn/2013/05/12/pyqt-model-view-framework/"/>
      <pubDate>2013-05-12T00:00:00+08:00</pubDate>
      <author>William Fang</author>
      <guid>http://williamlfang.github.com/cn/2013/05/12/pyqt-model-view-framework</guid>
      <content:encoded><![CDATA[
<h2 id="section">概述</h2>

<p>ui设计中，经常会有展示一系列数据的情况，如果是log那种流动的文字信息，可以用<a href="http://qt-project.org/doc/qt-4.8/qtextedit.html">QTextBrowser</a>来展示（<a href="../../13/log-handler-with-qtextbrowser/">参见这篇文章</a>）。如果是列表式的（树形，表形之类的），可以考虑用Qt的<a href="http://qt-project.org/doc/qt-4.8/model-view-programming.html">Model/View Framework</a>。这篇文章会介绍如何自定义model和如何使用model。一般来说，会这些就足够实现一些简单的功能了。Qt的delegate可能以后会添一篇文章，毕竟现在我也没怎么用过delegate。</p>

<p>这个框架利用了经典的MVC设计模式，model用来提供数据，view用来展示数据，control用来控制view对用户输入的反应。而在Qt里，view和controller被合并成了view，也就是说Qt里的view有了（初步的）反应用户输入的功能，而为了提供灵活的处理方式，Qt引入了delegate。delegate可以自定义数据显示（render）和修改的方式。</p>

<p>Qt提供了<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html">QAbstractItemModel</a>给我们作为实现自定义的model的基础，而对于列表和树形表型则分别提供了更具体的<a href="http://qt-project.org/doc/qt-4.8/qabstractlistmodel.html">QAbstractListModel</a>，<a href="http://qt-project.org/doc/qt-4.8/qabstracttablemodel.html">QAbstractTableModel</a>。然后Qt还提供了一些做好的model比如<a href="http://qt-project.org/doc/qt-4.8/qstandarditemmodel.html">QStandardItemModel</a>，<a href="http://qt-project.org/doc/qt-4.8/qsqlquerymodel.html">QSqlQueryModel</a>等等，可以算是<a href="http://docs.python.org/2/tutorial/stdlib.html#batteries-included">batteries included</a>。</p>

<p>这里主要用例子来介绍<a href="http://qt-project.org/doc/qt-4.8/qabstracttablemodel.html">QAbstractTableModel</a>，<a href="http://qt-project.org/doc/qt-4.8/qabstractlistmodel.html">QAbstractListModel</a>的使用方法很类似。</p>

<p>例子来自于（操蛋的）<a href="https://github.com/mad4alcohol/os-experiments">操作系统实习</a>，最终实现效果如图 <img src="/assets/images/pyqt-model-view-framework/overview.png" alt="overview.png" /></p>

<p>说下每个地方是干什么的。用户首先输入进程名和大小，点添加之后会在上面的列表控件里面添加一项，用来显示进程相关的信息。同时会为这个进程创造一个页表对象（见源码的PageTable类），由于一个进程对应一个页表，也就是说会有多个页表对象，那么在选中上面的列表中的项目的时候，下面的页表列表控件也要切换到相应的PageTable对象上去。用户可以选择任意的页面然后点击释放按钮来释放页面。对应地，内存空间在变化的时候，位示图（图中右边的那个Table控件）也要变化。</p>

<p>整理一下需求</p>

<ul>
  <li>程序需要至少3个model来为3个view提供数据</li>
  <li>要能向进程列表添加表项</li>
  <li>要能切换不同的页表对象（model）到页表列表上，实现同上</li>
  <li>页表列表要能根据进程的分配和释放而变化</li>
  <li>位示图控件要能根据空间的变化而变化</li>
</ul>

<p>经过（很长时间的）文档翻阅，初步得出一些思路</p>

<ul>
  <li>列表控件的变化利用model的<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#beginInsertRows"><code>beginInsertRows()</code></a>，<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#endInsertRows"><code>endInsertRows()</code></a>等来实现</li>
  <li>数据的修改可以直接在自定义的model中内置的数据存储中修改</li>
</ul>

<h2 id="model">自定义一个Model</h2>

<p>首先来实现存放进程列表用的model——ProcessModel，继承自<a href="http://qt-project.org/doc/qt-4.8/qabstracttablemodel.html">QAbstractTableModel</a>，为了实现这个类，我们必须实现几个必要的方法</p>

<ul>
  <li><code>__init__</code></li>
</ul>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="nb">super</span><span class="p">(</span><span class="n">ProcessModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
<span class="lineno">3</span> 
<span class="lineno">4</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
<span class="lineno">5</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_proc_list</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="lineno">6</span> 
<span class="lineno">7</span>     <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39;进程名&#39;</span><span class="p">,</span> <span class="s">u&#39;已分配 (kB)&#39;</span><span class="p">]</span>
<span class="lineno">8</span> 	
</code></pre>
</div>

<ul>
  <li><a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#rowCount"><code>rowCount()</code></a>用来定义列表项的个数</li>
</ul>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">rowCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc_list</span><span class="p">)</span>
<span class="lineno">3</span> 	
</code></pre>
</div>

<ul>
  <li><a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#columnCount"><code>columnCount()</code></a>用来定义列数，这里我们只有两列，所以返回定值</li>
</ul>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">columnCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="k">return</span> <span class="mi">2</span>
<span class="lineno">3</span> 	
</code></pre>
</div>

<ul>
  <li><a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#data"><code>data()</code></a>用来根据给定的index和role来返回数据</li>
</ul>

<p>以下简要的来说一下role是个什么东西。</p>

<p>在model/view框架中，role就跟它自己的名字表示的意思一样，是用来控制data表示的是什么东西的，比如给定某index和<code>role=Qt.DisplayRole</code>来调用[<code>data</code>][]，那么返回的数据就是用来显示这个index表示的位置上的内容的。
如果给定某index和<code>role=Qt.TextAlignmentRole</code>来调用[<code>data</code>][]，那么返回的数据就是用来控制这个index表示的位置上的内容的文字对齐方向的。
用户也可以自己定义一些role，从Qt.UserRole开始，每次加1就表示一个新role，同时在delegate中也要控制对应的role。
像这样的role还有很多，具体可见 <a href="http://qt-project.org/doc/qt-4.8/qt.html#ItemDataRole-enum">文档</a> 。 </p>

<p>这里不得不说一下pyqt的实现细节，由于重载的是Qt对象的方法，所以data的返回值最好是Qt内置的数据类型，比如<a href="http://qt-project.org/doc/qt-4.8/qstring.html">QString</a>之类的，一般来说，属于python的数据类型在返回前是用<a href="http://qt-project.org/doc/qt-4.8/qvariant.html">QVariant</a>包起来的，在实际使用的时候解包也很简单，调用<a href="http://pyqt.sourceforge.net/Docs/PyQt4/pyqt_qvariant.html"><code>toPyObject()</code></a>即可。</p>

<p>所以<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#data"><code>data()</code></a>的主要代码就是</p>

<div class="highlight"><pre><code class="python"><span class="lineno"> 1</span> <span class="n">proc_name</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc_list</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">row</span><span class="p">]</span>
<span class="lineno"> 2</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc_list</span><span class="p">[</span><span class="n">proc_name</span><span class="p">]</span>
<span class="lineno"> 3</span> <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">TextAlignmentRole</span><span class="p">:</span>
<span class="lineno"> 4</span>     <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno"> 5</span>         <span class="k">return</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span>
<span class="lineno"> 6</span>     <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="lineno"> 7</span>         <span class="k">return</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AlignLeft</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span>
<span class="lineno"> 8</span> <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">:</span>
<span class="lineno"> 9</span>     <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">10</span>         <span class="k">return</span> <span class="n">QString</span><span class="p">(</span><span class="n">proc_name</span><span class="p">)</span>
<span class="lineno">11</span>     <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="lineno">12</span>         <span class="k">return</span> <span class="n">QVariant</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="lineno">13</span> <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ForegroundRole</span><span class="p">:</span>
<span class="lineno">14</span>     <span class="k">if</span> <span class="n">proc_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">last_alloc</span><span class="p">:</span>
<span class="lineno">15</span>         <span class="k">return</span> <span class="n">QBrush</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>
<span class="lineno">16</span> <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span><span class="p">:</span>
<span class="lineno">17</span>     <span class="k">return</span> <span class="n">proc_name</span>
<span class="lineno">18</span> <span class="k">return</span> <span class="n">QVariant</span><span class="p">()</span>
</code></pre>
</div>

<p>当然还有一些boilerplate</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">index</span><span class="o">.</span><span class="n">column</span><span class="p">()</span>
<span class="lineno">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">()</span> \
<span class="lineno">3</span>     <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())</span> \
<span class="lineno">4</span>     <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnCount</span><span class="p">()):</span>
<span class="lineno">5</span>     <span class="k">return</span> <span class="n">QVariant</span><span class="p">()</span>
</code></pre>
</div>

<p>还有一些非必要的方法，比如用来提供header数据的类似data的方法<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#headerData"><code>headerData()</code></a></p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">headerData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span> <span class="ow">and</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">:</span>
<span class="lineno">3</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
</code></pre>
</div>

<p>然后说说怎么合法地对model的数据做修改，根据文档中Resizable models的一节里说的，插入新数据前必须调用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#beginInsertRows"><code>beginInsertRows()</code></a>，插入结束后必须调用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#endInsertRows"><code>endInsertRows()</code></a>，同样，删除数据前必须调用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#beginRemoveRows"><code>beginRemoveRows()</code></a>，删除结束后必须调用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#endRemoveRows"><code>endRemoveRows()</code></a>，如果不这么做，根据实验，view中不会有变化。（对列的变化应该是一样的，但是我们这个例子中并不涉及到对列的修改，所以在此略去）。如果列表项的数量没有增加或者减少，只是内容改变了，则需要发射<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#dataChanged"><code>dataChanged(QModelIndex, QModelIndex)</code></a>信号。根据我的实验，发射信号带的参数只需要是两个空的<a href="http://qt-project.org/doc/qt-4.8/qmodelindex.html"><code>QModelIndex()</code></a>就行了，可能数据量大了之后，指明范围会比较好。</p>

<p>其实在很多修改model内数据的场合下，我们并不知道数据到底是会多还是会少，或者增删数据不好分离出来，在这些情况下，调用上面说的<code>beginXXXRows()</code>和<code>endXXXRows()</code>还是比较困难的。</p>

<p>这样，我们就可以算是完整地实现了一个model。直接调用view的<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html#setModel"><code>setModel()</code></a>方法就行了。</p>

<h2 id="view">有关View</h2>

<p>接下来说说view，这篇文章并不打算继承一个view类，因为很多<a href="http://qt-project.org/doc/qt-4.8/model-view-programming.html#view-classes">Qt提供了很多view</a>，很多view直接拿现成的来就可以用。</p>

<p>为了实现这种genuine的带列的列表，我们只能选<a href="http://qt-project.org/doc/qt-4.8/qtreeview.html">QTreeView</a>了，<a href="http://qt-project.org/doc/qt-4.8/qtableview.html">QTableView</a>我试过，效果并不好，然后<a href="http://qt-project.org/doc/qt-4.8/qlistview.html">QListView</a>是压根就不能带列，<a href="http://qt-project.org/doc/qt-4.8/qcolumnview.html">QColumnView</a>就更不明觉厉了。</p>

<p>生的<a href="http://qt-project.org/doc/qt-4.8/qtreeview.html">QTreeView</a>看起来是这样的 <img src="/assets/images/pyqt-model-view-framework/raw-treeview.png" alt="raw-treeview.png" />为了让它变熟，得先用<a href="http://qt-project.org/doc/qt-4.8/qtreeview.html#rootIsDecorated-prop"><code>setRootIsDecorated()</code></a>去掉左边的树形图用的线，然后用<a href="http://qt-project.org/doc/qt-4.8/qtreeview.html#itemsExpandable-prop"><code>setItemsExpandable()</code></a>让项目不能展开。变成这样 <img src="/assets/images/pyqt-model-view-framework/usable-treeview.png" alt="usable-treeview.png" /></p>

<p>接下来调用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html#setModel"><code>setModel()</code></a>来设置view使用的model对象。虽然是<a href="http://qt-project.org/doc/qt-4.8/qtreeview.html">QTreeView</a>，但是它仍然支持<a href="http://qt-project.org/doc/qt-4.8/qabstracttablemodel.html">QAbstractTableModel</a>。你也可以把这个model应用到<a href="http://qt-project.org/doc/qt-4.8/qtableview.html">QTableView</a>上，看看展示效果上的区别。</p>

<h2 id="delegate">如何交互（只读，可编辑的要涉及到delegate）</h2>

<p>然后说说交互方面，比如进程项目的添加、页表的转换之类的。</p>

<p>向进程列表中添加进程项目，首先要调用model的<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#beginInsertRows"><code>beginInsertRows()</code></a>，然后修改数据来源（比如我们这里是个内置的<a href="http://docs.python.org/2/library/collections.html#collections.defaultdict">defaultdict</a>），修改完毕之后调用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#endInsertRows"><code>endInsertRows()</code></a>。</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginInsertRows</span><span class="p">(</span><span class="n">QModelIndex</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno">2</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc_list</span><span class="p">[</span><span class="n">proc_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
<span class="lineno">3</span> <span class="bp">self</span><span class="o">.</span><span class="n">endInsertRows</span><span class="p">()</span>
</code></pre>
</div>

<p>其中调用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemmodel.html#beginInsertRows"><code>beginInsertRows()</code></a>的时候用到的参数是<code>index, start, end</code>，这里为了简单，取了一些定值，对实际效果（好像）也没什么影响。
删除项目也是差不多了，这里不再赘述。</p>

<p>为了显示每个进程的对应列表，必须知道在进程列表中，当前选中的是哪一项。在<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html">QAbstractItemView</a>里有一个方法<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html#selectionModel"><code>selectionModel()</code></a>可以拿到这个view的<a href="http://qt-project.org/doc/qt-4.8/qitemselectionmodel.html">QItemSelectionModel</a>，它管理这个view关于<em>选择</em>的一切信息。可以同过它拿到被选中的行、列，或者判断是否有行或列被选中（具体方法参见<a href="http://qt-project.org/doc/qt-4.8/qitemselectionmodel.html">文档</a>。这里我们要用的是它的<a href="http://qt-project.org/doc/qt-4.8/qitemselectionmodel.html#currentRowChanged"><code>currentRowChanged()</code></a>信号。</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc_list_view</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">(),</span>
<span class="lineno">2</span>              <span class="n">SIGNAL</span><span class="p">(</span><span class="s">&#39;currentRowChanged(QModelIndex, QModelIndex)&#39;</span><span class="p">),</span>
<span class="lineno">3</span>              <span class="bp">self</span><span class="o">.</span><span class="n">switch_page_table_model</span><span class="p">)</span>
</code></pre>
</div>

<p>然后是这个信号连接到的槽的代码</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">switch_page_table_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="n">proc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_model</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span><span class="p">)</span>
<span class="lineno">3</span>     <span class="bp">self</span><span class="o">.</span><span class="n">current_proc_name</span> <span class="o">=</span> <span class="n">proc_name</span>
<span class="lineno">4</span>     <span class="bp">self</span><span class="o">.</span><span class="n">page_table_view</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page_table_models</span><span class="p">[</span><span class="n">proc_name</span><span class="p">])</span>
</code></pre>
</div>

<p>我维护了一个<a href="http://docs.python.org/2/library/collections.html#collections.defaultdict">defaultdict</a>，进程名做键，PageTableModel作为值，这个函数首先通过index拿到这个index对应的进程名<code>proc_name</code>，然后用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html#setModel"><code>setModel()</code></a>方法切换<code>self.page_table_view</code>使用的model。实现起来还是比较简单的。</p>

<p>如果要改变一个view的选择模式，可以调用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html#selectionMode-prop"><code>setSelectionMode()</code></a>，这里我使用的是默认的，而页表控件可以使用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html#SelectionMode-enum">ExtendedSelection模式</a>来开启多选功能。如果要获得选中项，仍然可以通过<a href="http://qt-project.org/doc/qt-4.8/qitemselectionmodel.html">QItemSelectionModel</a>来获得，也可以使用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html#selectedIndexes"><code>selectedIndexes()</code></a>来获取（我猜测这个方法只是对<a href="http://qt-project.org/doc/qt-4.8/qitemselectionmodel.html">QItemSelectionModel</a>的一些方法做了一个convenience包装）。Qt为啥要还要单独提供一个model来表示选中项呢？我的理解是，这也是为了灵活性做的一个解耦，有了这个类，我们就可以利用<a href="http://qt-project.org/doc/qt-4.8/qabstractitemview.html#setSelectionModel"><code>setSelectionModel()</code></a>同步两个或者多个view的selection了。要注意的是这些view使用的model最好相同，model不同的话，同步selection好像也没什么意义。</p>

<p>示例代码</p>

<div class="highlight"><pre><code class="python"><span class="lineno">1</span> <span class="n">model</span> <span class="o">=</span> <span class="n">YourModel</span><span class="p">()</span>
<span class="lineno">2</span> <span class="n">view1</span> <span class="o">=</span> <span class="n">QTableView</span><span class="p">()</span>
<span class="lineno">3</span> <span class="n">view1</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="lineno">4</span> <span class="n">view2</span> <span class="o">=</span> <span class="n">QListView</span><span class="p">()</span>
<span class="lineno">5</span> <span class="n">view2</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="lineno">6</span> <span class="c"># 注意：只有在setModel之后才能设置selectionModel</span>
<span class="lineno">7</span> <span class="c"># 因为只有在设置了model之后view才会生成自己的selectionModel</span>
<span class="lineno">8</span> <span class="c"># 如果在setModel之前设置，python会崩溃</span>
<span class="lineno">9</span> <span class="n">view2</span><span class="o">.</span><span class="n">setSelectionModel</span><span class="p">(</span><span class="n">view1</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">())</span>
</code></pre>
</div>

<h2 id="delegate-1">关于delegate</h2>

<p>这篇文章就先不介绍这个了，我自己用的也不多。感兴趣的可以先看看<a href="http://files.meetup.com/2179791/pyqt-model-view-framework-overview.pdf">这个文档</a>，是一位台湾友人写的，我觉得写的挺好的，不过毕竟是个overview，所以内容也不多，剩下的就要靠各位自己钻研了。</p>

<h2 id="section-1">后记</h2>

<p>本文的代码可以在<a href="https://github.com/mad4alcohol/os-experiments">这个repo</a>找到（前面也说过了）。</p>

]]></content:encoded>
    </item>
    
    <item>
      <title>不规范地简述一下JPEG原理</title>
      <link href="http://williamlfang.github.com/cn/2013/05/10/jpeg-thoughts/"/>
      <pubDate>2013-05-10T00:00:00+08:00</pubDate>
      <author>William Fang</author>
      <guid>http://williamlfang.github.com/cn/2013/05/10/jpeg-thoughts</guid>
      <content:encoded><![CDATA[<p>最近在做水得一比的信安大赛，按指导老师要求，去看了JPEG相关的东西。这里稍微记录一下。</p>

<p>如果对JPEG的背景什么的感兴趣可以去看看 <a href="http://en.wikipedia.org/wiki/JPEG">JPEG的wiki页面</a> 。</p>

<p>说到JPEG，就不能不说DCT。</p>

<p>所谓<a href="http://en.wikipedia.org/wiki/Discrete_cosine_transform">DCT (Discrete Cosine Transform)</a>，离散余弦变换，跟离散傅里叶变换类似，可以用来把时空域的数据变换到频域上。</p>

<p>这里直接说二维DCT变换，变换的输入是一个矩阵A（比如一个方阵，内容是0到255，即一个字节的整数）：
<img src="/assets/images/jpeg-thoughts/jpeg-thoughts-mat-a.png" alt="jpeg-thoughts-mat-a.png" />
变换的输出是一个浮点数矩阵B <img src="/assets/images/jpeg-thoughts/jpeg-thoughts-mat-b.png" alt="jpeg-thoughts-mat-b.png" />
可以看到除了矩阵左上角以外，其他元素基本上都是0左右的数。如果把这些数全部取值为0得到B’，再做逆变换得到矩阵A’，可以发现，A’的每个元素值跟A的每个元素值差距不大。也就是说，A的能量，经过DCT，被很好的聚集到了B的左上角（实际上如果去看DCT-I的公式可以发现结果向量的第一个值实际上就是输入向量的所有元素的平均值）。位于(0, 0)的值就是DC系数，左上角的其他值可以被认为是低频的AC系数，除了左上角的值可以称为是高频的AC系数，由于人对低频信息敏感，对高频信息不敏感，也就可以认为原对于人来说，矩阵A的主要信息都在B（和B’）的左上角。</p>

<p>JPEG能压缩图片的最主要的原理就在DCT里面：经过DCT变换之后，再舍去一部分无关紧要的信息，这样就减少了要编码的信息的量，从而达到压缩的功能。</p>

<p>JPEG规范要求将输入图片（比如灰度图）按8x8分块，每块做DCT变换，然后舍去一些高频信息（也叫量化），然后编码器用熵编码之类的方法对量化过的信息进行无损压缩，也就是说JPEG的压缩损失来自于量化这一步，最后是编码器按照JPEG规范，使用规范好的语法和结构来写出合法的JPEG文件。</p>

<p>JPEG解码基本上是上面的逆变换。</p>

<p>用语和概念可能并不规范，甚至有误，请包涵。</p>

]]></content:encoded>
    </item>
    
    <item>
      <title>2012年的暑假总结</title>
      <link href="http://williamlfang.github.com/cn/2012/09/02/summer-summary/"/>
      <pubDate>2012-09-02T00:00:00+08:00</pubDate>
      <author>William Fang</author>
      <guid>http://williamlfang.github.com/cn/2012/09/02/summer-summary</guid>
      <content:encoded><![CDATA[<p>将近2两个月的暑假过去了，写点总结性的东西，填充一下文章的数量。</p>

<h2 id="section">首先</h2>

<p>还没考完试就被一个密码学的老师邀请去做东西，这是_第二次_跟着这个老师了，第一次退出是因为，做出来第一个小东西之后，就给我了一个<em>在我看来</em>很专业的东西，被吓尿，然后就发了封邮件，说打算以后有基础了再弄。这次也是没搞几天就退了。哎，弄的东西实在是提不起兴趣，而且用的尽是我不喜欢的技术（<a href="http://www.cplusplus.com/">洗屁屁</a>和<a href="http://www.java.com/">假娃</a>什么的），跟我最开始想去实验室干活的目的不一样。不过这次我也学到了两件事：</p>

<blockquote>
  <ul>
    <li>一是实验室永远用的都不会去用小众的东西，C就不说了，这货暂时还是不可替代的，cpp/java/c#可以说是大行其道，所以<strong>永远不要</strong>抱着<strong>试试Scala，Clojure之类的东西在实战中是个什么样子</strong>这种心态去找实验室，这是<strong>不可能</strong>的！想玩这些东西，呵呵，自己家里鼓捣鼓捣就算了吧。</li>
    <li>二是写任何东西，不可能做到<strong><font color="red">不去了解背景知识就能完成</font></strong>的。</li>
  </ul>
</blockquote>

<h2 id="section-1">然后</h2>

<p>是跟另外一个同学一起做了一个比较坑的东西：python做一个特定领域搜索网站的爬虫。呵呵，坑人的地方就在于——<strong>要爬<font color="red">所有</font>东西下来</strong>！！而且，最开始还不知道这个需求，所以信誓旦旦地根据以前的经验说3天拿下，但是最后需求变得越来越，怎么说，烦人。最后是花了快20天，呵呵。收获就是，熟悉了一下python的线程（以前只有单线程抓东西，和actor模型的经验）和基础的pyqt。</p>

<h2 id="section-2">再然后</h2>

<p>想在github上搭一个博客，以前试过<a href="https://github.com/hyde/hyde">Hyde</a>这个python写的静态网站生成器，但是文档太少，所以放弃了。于是这次试了Jekyll（准确的说是<a href="http://jekyllbootstrap.com">Jekyll-Bootstrap</a>。配置也不是很难，以后记起来了就另开一篇说说。弄好了之后顺便去买了个域名，配置了一下CNAME什么的。然后配置了一下emacs，稍微学了学emacs lisp，也写了一个<a href="https://github.com/mad4alcohol/mfa-elisp-lib">小插件</a>练练手。最开始是打算专门写博客用的，但是后来也还是配置了一下<a href="clojure-mode">clojure-mode</a>，顺带着也弄了一下<a href="https://github.com/technomancy/leiningen">Leiningen</a>（另，这货在arch下面还挺难装的，最后还是在emacs里不知不觉自己就弄好了）。配置emacs的东西都在前两篇文章里。</p>

<h2 id="section-3">最后</h2>

<p>是写了一个<a href="https://github.com/mad4alcohol/LaborHourInputter">工票录入系统</a>，目的是加快工票的输入（原来是直接在写好的excel表格里输入工时之类的数据），所以根据用户需求，用才熟悉起来的pyqt弄了一个专门输入工票的界面。一直到现在都很简单，一天完事。这之后用户又有需求了：写出到excel之前，要用现在已有的数据算出工人的绩效，然后再跟工时废品之类的数据一起写到给定的excel的sheet里。这个工作，根据跨平台的原则，当然是首先考虑pypi里的可以跨平台的东西，所以看起来是可以用<a href="http://sourceforge.net/projects/pyexcelerator/">pyExcelerator</a>或者<a href="http://pypi.python.org/pypi/xlutils">xlutils</a>这种东西来弄的，但是经过实践</p>

<blockquote>
  <ul>
    <li>用pyExcelerator写入的话，所有格子的style消失，所有公式消失，基本可以说废掉了</li>
    <li>用xlutils的话，压根就写入不了（可能是操作有误吧）</li>
  </ul>
</blockquote>

<p>最后只能去试试用<a href="http://sourceforge.net/projects/pywin32/">pywin32</a>的win32com模块了，随便去搜了搜，看起来好像很复杂，但是仔细看了一下某个邮件列表的某个邮件存档（链接已经忘了），发现用COM去操作excel还是挺简单的，直接定位之后给<code>Value</code>属性赋值就行了，然后设置style就是直接给<code>Style</code>属性赋值，比如<code>cell.Style = 'Percent'</code>（如果设置<code>xl_app.Visible = True</code>会有很有意思的事情发生）。摸清楚之后，剩下工作的工期缩短了500%（预期是十几天断断续续地弄）。收获也还是有的，熟悉了一下数据库之类的东西，但是因为用的是<a href="http://www.sqlalchemy.org/">SQLAlchemy</a>，所以很不熟悉底层的操作（比如sql语句什么的），这也导致数据库那块的效率略低，然后稍微用了一下 <a href="http://pypi.python.org/pypi/xlrd">xlrd</a>去读存在表格里的工人信息，然后实践了一下抽象类之类的东西，目前感觉继承还是只是一种消除重复的机制，并没有那么神奇或者不可捉摸。反正目前我发现的办法就是，先写两个需要用的类出来（没有两个以及以上类似的类就暂时不需要抽象类对吧？），然后<em>并排打开</em>，从<strong>字面上</strong>提取出重复，放到一个抽象类里去，然后去掉这两个类的重复部分。</p>

<p>另外考虑到用户的<em>非</em>专业人员的属性，为每个项目入口点（比如输入界面和输出到表格）做了一个batch文件（给安装也做了一个脚本，静默安装python，安装distribute库，安装pip，安装xlrd和sqlalchemy，最后是安装pyqt和pywin32，基本上是全自动，除了最后两个需要手动点几下Next，因为实在是没找到可以用的静默参数是啥）。</p>

]]></content:encoded>
    </item>
    
    <item>
      <title>Emacs总结（续）之YASnippet</title>
      <link href="http://williamlfang.github.com/cn/2012/08/02/emacs-summary-cont/"/>
      <pubDate>2012-08-02T00:00:00+08:00</pubDate>
      <author>William Fang</author>
      <guid>http://williamlfang.github.com/cn/2012/08/02/emacs-summary-cont</guid>
      <content:encoded><![CDATA[<p>这里我不建议用pac-ins装它，因为无论怎么按照网上给出的方法配置，重启之后都没有YASnippet这个菜单出现。我推荐的安装方法是去<a href="https://github.com/capitaomorte/yasnippet">YASnippet的主页</a>，按照README里的第一种方法安装，重启后成功出现了YASnippet菜单。</p>

<p>YASnippet的配置是非常简单的，只需要在<code>.emacs</code>中加入</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;load-path</span>
<span class="lineno">2</span>              <span class="s">&quot;your path to yasnippet&quot;</span><span class="p">)</span>
<span class="lineno">3</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;yasnippet</span><span class="p">)</span>
<span class="lineno">4</span> <span class="p">(</span><span class="nv">yas/global-mode</span> <span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>

<p>要说的一点是展开模板的快捷键Tab的设置，在主模式markdown-mode下，Tab被绑定到markdown-cycle，而辅模式yas-minor-mode下，Tab是yas/expand，被markdown-cycle覆盖了。这样非常不方便。解决的办法有两种：</p>

<ul>
  <li>取消markdown-mode对tab的占用，代码出处： <a href="http://calas.github.com/2009/11/20/using-yasnippets-in-markdown-mode.html">这篇博客</a></li>
</ul>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">markdown-unset-tab</span> <span class="p">()</span>
<span class="lineno">2</span>   <span class="p">(</span><span class="nv">define-key</span> <span class="nv">markdown-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;&lt;tab&gt;&quot;</span><span class="p">)</span> <span class="no">nil</span><span class="p">))</span>
<span class="lineno">3</span> <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;markdown-mode-hook</span> <span class="ss">&#39;markdown-unset-tab</span><span class="p">)</span>
</code></pre>
</div>

<ul>
  <li>将yas/expand绑定到其他快捷键上</li>
</ul>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;C-;&quot;</span><span class="p">)</span> <span class="ss">&#39;yas/expand</span><span class="p">)</span>
</code></pre>
</div>

<p>考虑到markdown里用tab的次数还是挺多的，我采用的是第二种方法。</p>

<p>再说下YASnippet的自定义模板吧，这么方便的工具不会自定义真是太浪费了。
我们从实例来说明。</p>

<h2 id="postmeta">第一个例子：post的meta信息模板</h2>

<p>大家知道，jekyll的post是由markdown编译而来的，而这些markdown文件（即post源文件）必须有一些可以为jekyll所用的meta信息（比如title，category之类的）才能被识别为一篇博客。本着<a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY原则</a>（是的，代码里的原则不光码代码的时候很受用，从字面上看，干别的事也是），现将这些meta信息做成一个snippet。</p>

<p>使用命令<code>M-x yas/new-snippet</code>来进入新建snippet的buffer，可以看到以下的内容</p>

<pre><code># -*- mode: snippet -*-
# name:
# key: 
# binding: direct-keybinding
# expand-env: ((some-var some-value))
# type: command
# --
</code></pre>

<p>其中</p>

<ul>
  <li><code>name</code>是在YASnippet中显示的名字</li>
  <li><code>key</code>是触发这个snippet所用的关键字</li>
  <li><code>binding</code>和<code>expand-env</code>是两个高级特性，这里不做说明</li>
</ul>

<p>接下来，将上面的信息改为（不需要的行可以删掉）</p>

<pre><code># name: post-meta
# key: pm
</code></pre>

<p>值得注意的是，这个new snippet的buffer的初始内容就是YASnippet的一个snippet，按tab可以自动跳到下一个要填内容的地方。</p>

<p>接着在<code># --</code>后面一行按照要求的格式写下我们需要的meta信息</p>

<pre><code>---
layout: post
title: "${1:Title}"
description: ""
category: $2
tags:[$3]
---
{% include JB/setup %}
$0
</code></pre>

<p>这其中形如${N:Some Text}的内容被称为字段，N是tab stop序号（顺序是从$1到$N的），冒号后面的文字（如Title）则是其中的默认值。最后$0被称为YASnippet的退出点，即一个key被展开为snippet，并按顺序走完所有tab stop之后光标停留的点。</p>

<p>现在这个snippet就写好了。别忘了_保存_！如果你是按照github上的安装方法安装的，可以用<code>C-x C-s ~/.emacs.d/plugins/yasnippet/snippets/markdown/post-meta</code>把这个snippet保存在YASnippet的markdown分类下。</p>

<p>重启之后，新建一个md文件，emacs会自动进入markdown-mode和yas-minor-mode以及其他的一些minor-mode，这时你可以在空白处输入<code>pm</code>，然后用命令<code>M-x yas/expand</code>或者用它的快捷键（我的是<code>C-;</code>），就可以看到pm被扩展成了上面那几句，如图</p>

<p><img src="/assets/images/emacs-summary-cont/post-meta-screenshot.png" alt="post-meta-screenshot.png" /></p>

<p>如果不能展开，那么就要注意一下展开时你的光标的位置：光标不能处于key上，只能在你正常打完key的时候光标的那个位置（即key的最后一个字母之后）。同时key也有要求，除了空白符（空格，tab等）周围不能有其他字符。</p>

<p>然后就可以按tab，依次输入信息了。</p>

<h2 id="tag">第二个例子：高亮代码tag模板</h2>

<p>用jekyll写博客时，插入代码片段要用到liquid的tag（准确地说是jekyll给liquid写的扩展tag）如下</p>

<pre><code>{% highlight lang linenos %}
{% endhighlight %}
</code></pre>

<p>这里的<code>lang</code>是一个语言的缩写形式，比如Common Lisp是<code>cl</code>，Python是<code>python</code>（其他语言的名字可以查 <a href="http://pygments.org/docs/lexers">Pygments的Lexer页面</a> ）。本着DRY原则，应该将这些重复性的操作给抽取出来。</p>

<p>跟上一个例子的操作一样，进入new snippet的buffer，其中</p>

<ul>
  <li><code>name</code>设为<code>highlight</code></li>
  <li><code>key</code>设为<code>hl</code></li>
</ul>

<p>其他的meta可以删掉，snippet正文如下</p>

<pre><code>{% highlight ${1:cl} linenos %}
$0
{% endhighlight %}
</code></pre>

<p>保存并重启之后，在markdown-mode下就可以把<code>hl</code>展开为上面那一段了，基本消灭了重复操作。</p>

<h2 id="section">最后一个例子，也是最复杂的一个，但是也是最好玩的一个</h2>

<p>markdown中的img标签语法为</p>

<pre><code>![ALT TEXT](URL)
</code></pre>

<p>很明显这个语法可以做成如下的snippet</p>

<pre><code>![${1:ALT TEXT}](${2:URL }) $0
</code></pre>

<p>但是这还不够。还可以更简单。</p>

<p>在开始之前，我想说一下这个博客的文件布局（同时也是jekyll blog的默认布局）</p>

<pre><code>root
  | --- _posts
  |       | --- 2012-07-31-hello-world-again.md
  | 	  | --- 2012-08-01-emacs-summary.md
  | 	  | --- 2012-08-02-emacs-summary-cont.md
  |
  | --- assets
  |       | --- images
  |       |       | --- emacs-summary
  |       |       |       | --- emacs-screenshot.png
  |       |       |
  |       |       | --- emacs-summary-cont
  |       |       |       | --- post-meta-screenshot.png
</code></pre>

<p>可以看到，图片可以用<code>/assets/images/post-name/xxx.extension</code>来访问（<code>post-name</code>是文章的名字，比如这篇博客的是<code>emacs-summary-cont</code>）。</p>

<p>观察了一下路径，发现<code>/assets/images/</code>是确定的，而实际上<code>post-name/</code>也是确定的，因为它实际上是文章源代码的路径去掉多余的修饰值（日期，扩展名）后的值，也就是这个post的实际名称，而且在emacs里编辑的时候，就已经知道路径了。然后<code>xxx.extension</code>原本是要手填的，但是可以用YASnippet的<code>yas/choose-value</code>特性把<code>/assets/images/post-name/</code>里是图片的文件名列出来，由我们来选择一个填入（为什么这样是可行的，因为我的习惯是先放图进去再接着写）。还剩一个要填的Alt Text，就把图片文件名填到Alt Text里去好了。这么一看，我们的录入量从<strong>整个的路径</strong>减少到了<strong>只用上下键选择</strong>的程度。<strong>这正是emacs的魅力所在</strong>。</p>

<p>为什么上面的设想是可行的？因为YASnippet支持在snippet中<em>嵌入elisp</em>代码！</p>

<p>整理一下已知量：</p>

<ul>
  <li>post的绝对路径，通过 <a href="http://www.gnu.org/software/emacs/manual/elisp.html">GNU Emacs Lisp Reference Manual</a> 的相关章节可以知道函数<code>buffer-file-name</code>返回形如<code>d:/workspace/2012-08-02-emacs-summary-cont.md</code>的绝对路径</li>
  <li>url的前缀，即<code>/assets/images/post-name/</code></li>
  <li>Alt Text，即图片url里的文件名（这里只是知道了Alt Text与文件名相同，实际上在这个时候文件名是不知道的）</li>
</ul>

<p>整理一下要求的量：</p>

<ul>
  <li>post的实际名称，如这篇文章的实际名称为<code>emacs-summary-cont</code></li>
  <li><code>/assets/images/post-name/</code>里的图片文件的列表</li>
</ul>

<p>接下来求解第一个问题，求一个post的实际名称。</p>

<p>首先把路径去掉，扩展名去掉，通过manual可以查得有两个函数可以用，于是代码如下</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">mfa/extract-file-name</span> <span class="p">(</span><span class="nv">file-name</span><span class="p">)</span>
<span class="lineno">2</span>   <span class="p">(</span><span class="nv">file-name-nondirectory</span> <span class="p">(</span><span class="nv">file-name-sans-extension</span> <span class="nv">file-name</span><span class="p">)))</span>
</code></pre>
</div>

<p>然后可以发现实际名称是把上一步得到的值，用<code>-</code>打散之后，去掉前3个，再用<code>-</code>合起来，手册可以查到有<code>concat</code>、<code>split-string</code>和<code>cdddr</code>（<code>cdr</code>的变形），但是没有查到类似python里的<code>join</code>的函数，只能自己写了</p>

<div class="highlight"><pre><code class="cl"><span class="lineno"> 1</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">mfa/join</span> <span class="p">(</span><span class="nv">l</span> <span class="nv">separator</span><span class="p">)</span>
<span class="lineno"> 2</span>   <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;concat</span>
<span class="lineno"> 3</span>          <span class="p">(</span><span class="nb">car</span> <span class="nv">l</span><span class="p">)</span>
<span class="lineno"> 4</span>          <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">str</span><span class="p">)</span> <span class="p">(</span><span class="nv">concat</span> <span class="nv">separator</span> <span class="nv">str</span><span class="p">))</span>
<span class="lineno"> 5</span>                  <span class="p">(</span><span class="nb">cdr</span> <span class="nv">l</span><span class="p">))))</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">mfa/remove-date</span> <span class="p">(</span><span class="nv">file-name</span><span class="p">)</span>
<span class="lineno"> 8</span>   <span class="p">(</span><span class="nv">mfa/join</span> <span class="p">(</span><span class="nb">cdddr</span> <span class="p">(</span><span class="nv">split-string</span> <span class="nv">file-name</span> <span class="s">&quot;-&quot;</span><span class="p">))</span>
<span class="lineno"> 9</span>             <span class="s">&quot;-&quot;</span><span class="p">))</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">mfa/get-directory-from-bufname</span> <span class="p">(</span><span class="nv">file-name</span><span class="p">)</span>
<span class="lineno">12</span>   <span class="p">(</span><span class="nv">mfa/remove-date</span> <span class="p">(</span><span class="nv">mfa/extract-file-name</span> <span class="nv">file-name</span><span class="p">)))</span>
</code></pre>
</div>

<p>稍微解释一下<code>mfa/join</code>（如果你懂一些lisp，以下内容可以跳过）：</p>

<ul>
  <li>首先把参数之一的列表l分成两份，l1表示<code>(car l)</code>，即l的第一个元素，lr（l-rest）表示<code>(cdr l)</code>，即去掉了l的头元素的剩下的列表。</li>
  <li>然后对lr做运算：每个元素的前面都加一个separator，例如若lr是<code>'("a" "b" "c")</code>，经过运算之后就是<code>'("-a" "-b" "-c")</code>了。这个运算用<code>mapcar</code>函数来实现，<code>mapcar</code>接受两个参数：一个函数，一个列表；<code>mapcar</code>把这个函数按顺序应用到这个列表的每一个元素上，并且把每一个函数应用的返回值按顺序收集起来，做成一个新列表，<code>mapcar</code>的运算结果就是这个新列表。</li>
  <li>把l1和lr拼起来。</li>
  <li>如果还是有问题可以用<code>M-x ielm</code>命令打开elisp的repl，自己去试验一下。</li>
</ul>

<p>（事后突然发现其实没必要那么麻烦。因为日期是固定长度的<code>xxxx-xx-xx</code>，可以直接去掉<code>file-name</code>的前11个字符（比日期多加了一个杠，所以是11个））</p>

<p>接下来求图像文件列表</p>

<p>要求一个文件列表，首先得知道文件的目录在哪，如果用绝对路径，这个目录是很好知道的，但是如果要保证跨平台性，只能使用相对路径，手册里查到一个函数<code>expand-file-name</code>可以完成相对路径展开到绝对路径的工作，
然后可以发现从我当前的编辑目录<code>./_posts</code>到<code>./assets</code>需要向上走一级目录，所求的目录用elisp表达出来即</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">mfa/get-images-directory</span> <span class="p">(</span><span class="nv">file-name</span><span class="p">)</span>
<span class="lineno">2</span>   <span class="p">(</span><span class="nv">concat</span> <span class="p">(</span><span class="nv">file-name-as-directory</span> <span class="p">(</span><span class="nv">expand-file-name</span> <span class="s">&quot;&quot;</span> <span class="s">&quot;../assets/images/&quot;</span><span class="p">))</span>
<span class="lineno">3</span>           <span class="p">(</span><span class="nv">mfa/get-directory-from-bufname</span> <span class="nv">file-name</span><span class="p">)))</span>
</code></pre>
</div>

<p>如果调用<code>(mfa/get-images-directory (buffer-file-name))</code>在我的电脑上可得返回值为<code>d:/workspace/blog-content/assets/images/emacs-summary-cont</code></p>

<p>接下来就可以用<code>directory-files</code>求得某个目录下的文件列表了，而且<code>directory-files</code>有个参数<code>:match-regexp</code>用来guard文件名。注意：这个函数返回的文件列表里的元素是绝对路径的，而我们只需要文件名，所以需要用<code>mapcar</code>处理一下，代码如下</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">mfa/list-image-files</span> <span class="p">(</span><span class="nb">directory</span><span class="p">)</span>
<span class="lineno">2</span>   <span class="p">(</span><span class="nb">mapcar</span> <span class="ss">&#39;file-name-nondirectory</span>
<span class="lineno">3</span>           <span class="p">(</span><span class="nv">directory-files</span> <span class="nb">directory</span>
<span class="lineno">4</span>                            <span class="ss">:match-regexp</span> <span class="s">&quot;\\.\\(png\\|jpg\\|jpeg\\|gif\\)&quot;</span><span class="p">)))</span>
</code></pre>
</div>

<p>Emacs Lisp用的正则表达式的语法是posix风格的（与vim一样），熟悉perl风格的同学们可能会觉得很奇怪（比如括号要转义了才有分组的作用）。</p>

<p>最后一步，弄一个函数把上面的函数拼起来，首先在脑袋里想好输入输出：输入是一个带绝对路径的文件名，输出是这个文件名对应的图片文件夹下的图片文件名列表。</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nb">defun</span> <span class="nv">mfa/yield-choices</span> <span class="p">(</span><span class="nv">file-name</span><span class="p">)</span>
<span class="lineno">2</span>   <span class="p">(</span><span class="nv">mfa/list-image-files</span> <span class="p">(</span><span class="nv">mfa/get-images-directory</span> <span class="nv">file-name</span><span class="p">)))</span>
</code></pre>
</div>

<p>这样一来，我们所有的elisp编码工作就完成了（可以看出来所有代码都是由函数拼起来的，这也是<a href="http://en.wikipedia.org/wiki/Functional_programming">函数式编程</a>的主要编码方式），可以把以上代码存入一个elisp文件中（注意，最后一行要写<code>(provide 'your-file-name)</code>），并在<code>.emacs</code>里配置一下，把这个文件像插件一样加载进来。</p>

<p>接下来，我们开始snippet的编码，这部分就相对来说容易很多了</p>

<pre><code>![${1:$$(yas/choose-value (mfa/yield-choices (buffer-file-name)))}](/assets/images/`(mfa/get-directory-from-bufname (buffer-file-name))`/$1)$0
</code></pre>

<p><em>注意</em>：里面是一行，不能折行。</p>

<p>这里主要用到了三个特性：<code>yas/choose-value</code>，内嵌elisp和镜像。</p>

<ul>
  <li>在扩展形如<code>${N:$$(yas/choose-value your-list)}</code>的snippet的时候，可以显示一个下拉菜单来选择要填入的内容；</li>
  <li>可以在snippet的任意地方嵌入用_反引号_括起来的elisp代码；</li>
  <li>在前面定义的tab stop，如果在后面有对它的引用，则会直接copy到后面的引用处，在上面的snippet里，前面作为Alt Text的文件名被镜像到后面的路径里去了。</li>
</ul>

<p>这样一来，我们所有的编码工作就完成了，将这个snippet保存至上面的markdown的snippet目录下，重启emacs之后就可以看效果了。</p>

<p>附效果截图一张：</p>

<p><img src="/assets/images/emacs-summary-cont/snippet-screenshot.png" alt="snippet-screenshot.png" /></p>

<p>这样就基本介绍了YASnippet的配置和自定义snippet（中间还穿插了一点elisp）。</p>

<h2 id="section-1">后记</h2>

<p>要知道YASnippet这个插件自身就是elisp写的，emacs的超高可配置性可见一斑，无怪乎说 <a href="http://c2.com/cgi/wiki?EmacsAsOperatingSystem"><strong>emacs就是一个操作系统</strong></a>了。</p>

<p>就我个人来看，虽然vim的编辑效率可以爆emacs几条街（我之前可以算是个坚定的vim党，额，可能没那么坚定，我更喜欢在ide里用vim插件，而不是直接用gvim），但是如果emacs加上扩展再去和vim比（哪怕vim也加扩展），那真是不好说了。</p>

<p>我开始体会到emacs的强大，也是自己摸索出来上面那个图片文件列表snippet之后了，而elisp正是emacs强大的根源所在。elisp开发（或者说lisp类的语言的开发）的过程也是非常愉悦的过程，你在主buffer里写着代码，写了两个函数，想试一下效果，可以直接eval一下buffer，然后在旁边的repl里立即进行测试，基本上等于_所写即所得编程_（好像是废话，但是你懂我说的），我想目前还没有别的语言能这么做，对于我这个不会单元测试（也不喜欢，如果是好lisp代码的话，应该是不需要单元测试的，因为本身就完全是<a href="http://en.wikipedia.org/wiki/Declarative_programming">声明式</a>的，要干什么一目了然）的人来说，真是救星一般的东西。另：elisp的文档也写得非常好，朴素且实用，就像emacs自己。</p>

<p>如果想进一步了解lisp这种<strong>神奇</strong>的东西，可以看看 <a href="http://book.douban.com/subject/6021440/">黑客与画家</a>。Paul Graham写的很精彩，但是我觉得略微有点太夸大lisp了（虽然lisp确实很强大） :)</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>折腾了一天的emacs，现在来写点总结</title>
      <link href="http://williamlfang.github.com/cn/2012/07/31/emacs-summary/"/>
      <pubDate>2012-07-31T00:00:00+08:00</pubDate>
      <author>William Fang</author>
      <guid>http://williamlfang.github.com/cn/2012/07/31/emacs-summary</guid>
      <content:encoded><![CDATA[<p>今天一起床，突然心血来潮，想配个emacs来玩玩。一来增加点见识，一个<em>编辑器</em>到底能做到什么水平；二来，如果真配好了，以后用起来也应该会很方便；再来，我本来就对lisp类的语言很感兴趣（其实只要不是命令式的都感兴趣，嘛，满大街都是imperative的，这不科学），而且最开始是想作为clojure的ide来弄的，配配emacs也算是增进对lisp的了解吧。</p>

<h2 id="section">准备工作</h2>

<ul>
  <li>过一遍emacs自带的tutorial，了解一下基本操作，后面的配置也就可以作为实际的练习了。另：有中文的，所以应该不是什么大问题，无奈的是emacs在windows下默认的字体渲染得很丑（ps: 这是可以解决的，详见后文）。</li>
  <li>了解lisp的基本知识，比如这种_奇怪_的语法（<a href="http://en.wikipedia.org/wiki/S-expression">S-expression</a>）是怎么回事，最开始可能不习惯，但是习惯之后，你就会明白这种语法的表达力有多强大（通过宏来体现出数据即代码，代码即数据）。</li>
</ul>

<p>接下来，开始<em>一块一块</em>地来看<code>.emacs</code>（即vim里的<code>.vimrc</code>）。</p>

<h2 id="emacs">哦，对了，首先要说的是.emacs放哪</h2>

<p>*nix就不说了，大家都知道。但是windows的情况就要复杂点了。
我先是稍微在网上搜了一下，说在<code>C:/Users/xxx/AppData/Roaming/.emacs.d</code>里建一个<code>init.el</code>。我试了，不行。（怎么试？就加一句<code>(tool-bar-mode -1)</code>，然后重启emacs看看有变化没。）百撕不得骑姐（大误）之后，还是打算换个关键字，用英语搜吧。果然搜到了一个关于windows的<a href="http://www.gnu.org/software/emacs/windows/Installing-Emacs.html#index-HOME-directory-49">faq</a>，里面的3.5节对确定主文件夹的机制讲得很清楚：
&gt; 1. 如果设置了<code>HOME</code>环境变量，那么就用<code>HOME</code>指代的文件夹。
&gt; 2. 如果注册表有<code>HKCU\SOFTWARE\GNU\Emacs\HOME</code>这一项，那么就用它指代的文件夹。
&gt; 3. 如果注册表有<code>HKLM\SOFTWARE\GNU\Emacs\HOME</code>这一项，那么就用它指代的文件夹。不推荐，因为它会让多个用户共享同一个主文件夹。
&gt; 4. 如果存在<code>C:\.emacs</code>，那么就用<code>C:/</code>。这么做是为了向前兼容，因为如果没有设置<code>HOME</code>，以前的版本会默认将其设置为<code>C:/</code>。
&gt; 5. 使用当前用户的<code>AppData</code>文件夹，通常是在当前用户的profile文件夹里一个叫做<code>Application Data</code>的文件夹，其路径根据Windows版本和计算机是否是域上的一部分而不同。</p>

<p>后面还有一句
&gt; 在Emacs中，一个文件名开头处的&lt;~&gt;会被展开为你的主文件夹，所以你总是可以用<code>C-x C-f ~/.emacs</code>找到你的<code>.emacs</code>文件。</p>

<p>我是直接用的第一个方法弄的，果然好使（还是官方文档靠谱啊）。</p>

<h2 id="section-1">外观部分</h2>

<p>首先得设置好语言环境（应该就是总编码的意思），
用以下代码设置</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nv">set-language-environment</span> <span class="ss">&#39;utf-8</span><span class="p">)</span>
</code></pre>
</div>

<p>其中<code>'utf-8</code>表示的是一个引用（quote），表示一个唯一确定的标识，跟java里的枚举类型有点类似。</p>

<p>然后设置汉字的渲染，
我在google上搜过，得到的结论是强制设定一个字体应该能解决问题，在<a href="http://emacser.com/torture-emacs.htm">这篇文章</a>里copy了一段代码</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">charset</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">kana</span> <span class="nv">han</span> <span class="nc">symbol</span> <span class="nv">cjk-misc</span> <span class="nv">bopomofo</span><span class="p">))</span>
<span class="lineno">2</span>   <span class="p">(</span><span class="nv">set-fontset-font</span> <span class="p">(</span><span class="nv">frame-parameter</span> <span class="no">nil</span> <span class="ss">&#39;font</span><span class="p">)</span>
<span class="lineno">3</span> 					<span class="nv">charset</span>
<span class="lineno">4</span> 					<span class="p">(</span><span class="nv">font-spec</span> <span class="ss">:family</span> <span class="s">&quot;微软雅黑&quot;</span> <span class="ss">:size</span> <span class="mi">12</span><span class="p">)))</span>
</code></pre>
</div>

<p>eval之后，渲染果然好多了，但是保存<code>.emacs</code>之后，新开一个emacs，又变回以前那种渲染了，经过又一次的百思不得其解之后，还是去翻文档，试着把<code>set-fontset-font</code>的第一个参数，即<code>(frame-parameter nil 'font)</code>，改成<code>"fontset-default"</code>，保存，重启，ok了。
然后设置英文字体，把其中的<code>Bitstream Vera Sans Mono</code>换成你想要的字体名就行了，比如<code>Consolas</code></p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;default</span> <span class="no">nil</span> <span class="ss">:font</span> <span class="s">&quot;Bitstream Vera Sans Mono-10&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>ps: 在这里强烈推荐一下<a href="http://ftp.gnome.org/pub/GNOME/sources/ttf-bitstream-vera/1.10/">Bitstream Vera Sans Mono</a>，非常耐看的字体，再配上mactype的渲染简直完美（*nix个发行版的桌面一般自带比windows好看的多的渲染，mac就更不用说了）;)。</p>

<p>接下来把那个烦人的工具栏去掉</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">fboundp</span> <span class="ss">&#39;tool-bar-mode</span><span class="p">)</span>
<span class="lineno">2</span>   <span class="p">(</span><span class="nv">tool-bar-mode</span> <span class="mi">-1</span><span class="p">))</span>
</code></pre>
</div>

<p>其中在设置之前检测一下应该是为了兼容<code>nw</code>模式（因为既然在控制台下，工具栏什么的肯定是没有的吧）。如果你也不喜欢菜单栏，可以照葫芦画瓢，设置<code>menu-bar-mode</code>为<code>-1</code>。</p>

<p>然后把总是在响的bell给关掉</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="k">setq</span> <span class="nv">visible-bell</span> <span class="no">t</span><span class="p">)</span>
</code></pre>
</div>

<p>值得一提的是<code>setq</code>（set quoted）与<code>set</code>的区别，基本可以理解为以下两个表达式等价</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="k">setq</span> <span class="nv">some-variable</span> <span class="no">t</span><span class="p">)</span>
<span class="lineno">2</span> <span class="p">(</span><span class="nb">set</span> <span class="ss">&#39;some-variable</span> <span class="no">t</span><span class="p">)</span>
</code></pre>
</div>

<p>然后设置主题，
我试过用<code>M-x package-install</code>装color-theme，也试过直接从color-theme的官网上下zip，在emacs24下都有问题：<code>Symbol's function definition is void: plist-to-alist</code>，去源码里一看，调用<code>plist-to-alist</code>的那句后面写着<code>XEmacs only</code>-_-|，试过把这句注释，或者加个<code>plist-to-alist</code>的假实现，都不行。最后看了一个stackoverflow的回答说emacs24自带了主题管理（好像以前的版本也有？），先在buffer里用<code>M-x customize-themes</code>看所有的主题，选一个，然后在<code>.emacs</code>里加入</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nv">load-theme</span> <span class="ss">&#39;wheatgrass</span> <span class="no">t</span><span class="p">)</span>
</code></pre>
</div>

<p>外观这部分最后要说的是两个插件：tabbar和lineno
但是在说tabbar的配置之前，要说一下emacs的package管理器的配置</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;package</span><span class="p">)</span>
<span class="lineno">2</span> <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;package-archives</span>
<span class="lineno">3</span> 	         <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;marmalade&quot;</span> <span class="o">.</span> <span class="s">&quot;http://marmalade-repo.org/packages/&quot;</span><span class="p">))</span>
<span class="lineno">4</span> <span class="p">(</span><span class="nv">package-initialize</span><span class="p">)</span>
</code></pre>
</div>

<p>具体来说就是将”marmalade”和这个repo的url作为一个cons存进<code>package-archives</code>里。
以后要安装什么插件，一般可以直接用命令<code>M-x package-install xxx</code>（以下简称pac-ins）安装。</p>

<p>首先用pac-ins安装lineno，然后在<code>(package-initialize)</code>后面加入</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nv">linum-mode</span> <span class="no">t</span><span class="p">)</span>
</code></pre>
</div>

<p>注意，所有跟用pac-ins安装的插件有关的代码都只能写在<code>(package-initialize)</code>后面，否则会提示找不到变量之类的错误。</p>

<p>然后安装tabbar，并加入以下代码</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;tabbar</span><span class="p">)</span>
<span class="lineno">2</span> <span class="p">(</span><span class="nv">tabbar-mode</span> <span class="no">t</span><span class="p">)</span>
</code></pre>
</div>

<p>重启之后就可以看到buffer上面都多了一行tab。</p>

<p>为了更加方便地使用tabbar，可以绑定两个快捷键到tabbar-xward上，比如</p>

<div class="highlight"><pre><code class="cl"><span class="lineno">1</span> <span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-j&quot;</span><span class="p">)</span> <span class="ss">&#39;tabbar-backward</span><span class="p">)</span>
<span class="lineno">2</span> <span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">&quot;M-k&quot;</span><span class="p">)</span> <span class="ss">&#39;tabbar-forward</span><span class="p">)</span>
</code></pre>
</div>

<p>另外，如果你觉得默认的样式很丑，可以用下面的代码来自定义，修改自<a href="http://blog.csdn.net/CherylNatsu/article/details/6204737">这篇文章</a>。</p>

<div class="highlight"><pre><code class="cl"><span class="lineno"> 1</span> <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;tabbar-default</span> <span class="no">nil</span>
<span class="lineno"> 2</span> 		    <span class="ss">:background</span> <span class="s">&quot;gray80&quot;</span>
<span class="lineno"> 3</span> 		    <span class="ss">:family</span> <span class="s">&quot;Bitstream Vera Sans Mono&quot;</span>
<span class="lineno"> 4</span> 		    <span class="ss">:foreground</span> <span class="s">&quot;gray30&quot;</span>
<span class="lineno"> 5</span> 		    <span class="ss">:height</span> <span class="mf">0.75</span><span class="p">)</span>
<span class="lineno"> 6</span> <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;tabbar-unselected</span> <span class="no">nil</span>
<span class="lineno"> 7</span> 		    <span class="ss">:inherit</span> <span class="ss">&#39;tabbar-default</span>
<span class="lineno"> 8</span> 		    <span class="ss">:background</span> <span class="s">&quot;gray85&quot;</span>
<span class="lineno"> 9</span> 		    <span class="ss">:foreground</span> <span class="s">&quot;gray30&quot;</span>
<span class="lineno">10</span> 		    <span class="ss">:box</span> <span class="no">nil</span><span class="p">)</span>
<span class="lineno">11</span> <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;tabbar-selected</span> <span class="no">nil</span>
<span class="lineno">12</span> 		    <span class="ss">:inherit</span> <span class="ss">&#39;tabbar-default</span>
<span class="lineno">13</span> 		    <span class="ss">:background</span> <span class="s">&quot;#f2f2f6&quot;</span>
<span class="lineno">14</span> 		    <span class="ss">:foreground</span> <span class="s">&quot;black&quot;</span>
<span class="lineno">15</span> 		    <span class="ss">:box</span> <span class="no">nil</span><span class="p">)</span>
<span class="lineno">16</span> <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;tabbar-button</span> <span class="no">nil</span>
<span class="lineno">17</span> 		    <span class="ss">:inherit</span> <span class="ss">&#39;tabbar-default</span>
<span class="lineno">18</span> 		    <span class="ss">:box</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">:line-width</span> <span class="mi">1</span>
<span class="lineno">19</span> 			   <span class="ss">:color</span> <span class="s">&quot;gray72&quot;</span>
<span class="lineno">20</span> 			   <span class="ss">:style</span> <span class="nv">released-button</span><span class="p">))</span>
<span class="lineno">21</span> <span class="p">(</span><span class="nv">set-face-attribute</span> <span class="ss">&#39;tabbar-separator</span> <span class="no">nil</span>
<span class="lineno">22</span> 		    <span class="ss">:height</span> <span class="mf">0.7</span><span class="p">)</span>
</code></pre>
</div>

<p>在那篇文章里，所有的<code>set-face-attribute</code>的第一个参数都以<code>-face</code>结尾，但是到我这来就没有了，所以直接copy过来是不能跑的。看了tabbar.el，那些face都是没有<code>-face</code>的，只好跟着把<code>-face</code>去掉了，重启一下，可以发现样式改过来了。</p>

<p>附上emacs截图一张
<img src="/assets/images/emacs-summary/emacs-screenshot.png" alt="截图" /></p>

<p>未完待续…</p>

]]></content:encoded>
    </item>
    
  </channel>
</rss>
